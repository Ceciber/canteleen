<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Interface - Canteleen</title>
  <link rel="stylesheet" href="/css/managerstyle.css">
</head>
<body>
  <div class="cashier-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <button onclick="showSection('menu')"><img src="/images/menuicon.png" alt="Menu" class="sidebar-icon"></button>
        <button onclick="showSection('orders')"><img src="/images/ordersicon.png" alt="Orders" class="sidebar-icon"></button>
      </div>
      <div class="sidebar-bottom">
        <hr>
        <button onclick="showSection('profile')"><img src="/images/profileicon.png" alt="Profile" class="sidebar-icon"></button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="cashier-main">
      <!-- Menu Section -->
      <section id="menu" class="active-section">
        <!-- Search Bar and Add Dish Button -->
        <div class="menu-top">
          <input type="text" placeholder="Search dishes..." class="menu-search-input">
          <button class="menu-add-btn" onclick="window.location.href='/adddish'">Add Dish</button>
        </div>
        
        <!-- Tabs for Filtering -->
        <div class="menu-tabs">
          <button class="menu-tab" onclick="filterMeals('All')">All</button>
          <button class="menu-tab" onclick="filterMeals('Meat')">Meat</button>
          <button class="menu-tab" onclick="filterMeals('Vegetarian')">Vegetarian</button>
          <button class="menu-tab" onclick="filterMeals('Fish')">Fish</button>
          <button class="menu-tab" onclick="filterMeals('Dessert')">Dessert</button>
        </div>
        
        <!-- Grid of Meal Tiles -->
        <div class="menu-grid">
          <!-- Tiles will be loaded dynamically -->
        </div>
      </section>

      <script>
        async function loadMeals() {
          try {
            const response = await fetch('/meals');
            const meals = await response.json();
            const grid = document.querySelector('.menu-grid');
            grid.innerHTML = '';
            meals.forEach(meal => {
              const tile = document.createElement('div');
              tile.className = 'meal-tile';
              tile.setAttribute('data-meal-type', meal.meal_type);
              tile.setAttribute('data-meal-id', meal.id);
              
              const nameDiv = document.createElement('div');
              nameDiv.className = 'meal-name';
              nameDiv.textContent = meal.meal_name;
              tile.appendChild(nameDiv);
              
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'meal-actions';
              
              // Copy button
              const copyBtn = document.createElement('button');
              copyBtn.textContent = 'Copy';
              copyBtn.onclick = async () => {
                const res = await fetch(`/meals/${meal.id}/copy`, { method: 'POST' });
                if (res.ok) loadMeals();
                else alert("Error copying meal");
              };
              actionsDiv.appendChild(copyBtn);
              
              // Modify button
              const modifyBtn = document.createElement('button');
              modifyBtn.textContent = 'Modify';
              modifyBtn.onclick = () => {
                window.location.href = `/modifydish?id=${meal.id}`;
              };
              actionsDiv.appendChild(modifyBtn);
              
              // Delete button
              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'X';
              deleteBtn.className = 'delete-btn';
              deleteBtn.onclick = async () => {
                const res = await fetch(`/meals/${meal.id}`, { method: 'DELETE' });
                if (res.ok) loadMeals();
                else alert("Error deleting meal");
              };
              actionsDiv.appendChild(deleteBtn);
              
              tile.appendChild(actionsDiv);
              grid.appendChild(tile);
            });
          } catch (error) {
            console.error(error);
          }
        }

        function filterMeals(category) {
          const tiles = document.querySelectorAll('.meal-tile');
          tiles.forEach(tile => {
            if (category === 'All' || tile.getAttribute('data-meal-type') === category)
              tile.style.display = 'block';
            else
              tile.style.display = 'none';
          });
        }

        function setupSearchBar() {
          const searchInput = document.querySelector('.menu-search-input');
          searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            document.querySelectorAll('.meal-tile').forEach(tile => {
              const name = tile.querySelector('.meal-name').textContent.toLowerCase();
              tile.style.display = name.includes(query) ? 'block' : 'none';
            });
          });
        }
        

        document.addEventListener("DOMContentLoaded", () => {
          loadMeals();
          setupSearchBar(); // ðŸ‘ˆ Add this line
        });
        
      </script>


      <!-- Orders Section -->
      <section id="orders" class="hidden-section">
        <h2>Orders Section</h2>
        <p>This is the placeholder for the orders interface.</p>
      </section>

      <!-- Profile Section -->
      <section id="profile" class="hidden-section">
        <!-- Profile header with welcome message -->
        <div class="profile-header">
          <h2>Welcome, <span id="profile-username">manager</span></h2>
        </div>

        <!-- Horizontal container for profile picture, details, and edit button -->
        <div class="profile-info">
          <!-- 1) Profile picture -->
          <div class="profile-picture">
            <img src="/images/profile.png" alt="Profile Picture">
          </div>

          <!-- 2) Profile details -->
          <div class="profile-details">
            <p>Name: <span id="profile-fullname">Jane Smith</span></p>
            <p>Email: <span id="profile-email">jane@example.com</span></p>
            <p>Role: <span id="profile-role">manager</span></p>
          </div>

          <!-- 3) Edit button -->
          <div class="profile-edit-btn">
            <button onclick="toggleProfileEdit()">Edit</button>
          </div>
        </div>

        <!-- Grid for editable fields (3 columns x 2 rows) -->
        <div class="profile-grid">
          <div class="profile-field">
            <label for="edit-fullname">Full Name</label>
            <input type="text" id="edit-fullname" value="Jane Smith" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-username">Username</label>
            <input type="text" id="edit-username" value="manager" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-gender">Gender</label>
            <input type="text" id="edit-gender" value="Female" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-country">Country</label>
            <input type="text" id="edit-country" value="France" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-language">Language</label>
            <input type="text" id="edit-language" value="French" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-email">Email</label>
            <input type="text" id="edit-email" value="jane@example.com" disabled>
          </div>
        </div>

        <!-- Erase Account and Log out Section -->
        <div class="account-actions">
          <p class="action-link" onclick="eraseAccount()">Erase account</p>
          <p class="action-link" onclick="logout()">Log out</p>
        </div>
        

        
      </section>

    </main>
  </div>

  <script>
    // Show the selected section and hide others
    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.style.display = section.id === sectionId ? 'block' : 'none';
      });
    
      if (sectionId === 'profile') {
        loadProfile(); // ðŸ‘ˆ Load from DB when switching to profile
      }
    }
    

    // Ensure the manager starts in the menu view
    document.addEventListener("DOMContentLoaded", () => {
      showSection('menu');
    });

    // Toggle between edit and save mode for profile editing
    async function toggleProfileEdit() {
      const inputs = document.querySelectorAll('.profile-field input');
      const editBtn = document.querySelector('.profile-edit-btn button');
    
      if (editBtn.textContent === "Edit") {
        inputs.forEach(input => input.disabled = false);
        editBtn.textContent = "Save";
      } else {
        // Collect updated profile info
        const updatedProfile = {
          full_name: document.getElementById('edit-fullname').value,
          gender: document.getElementById('edit-gender').value,
          country: document.getElementById('edit-country').value,
          language: document.getElementById('edit-language').value,
          email: document.getElementById('edit-email').value
        };
    
        try {
          const res = await fetch('/profile/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedProfile)
          });
          if (res.ok) {
            document.getElementById('profile-fullname').textContent = updatedProfile.full_name;
            document.getElementById('profile-email').textContent = updatedProfile.email;
            editBtn.textContent = "Edit";
            inputs.forEach(input => input.disabled = true);
          } else {
            alert("Error updating profile");
          }
        } catch (err) {
          console.error("Update failed:", err);
        }
      }
    }

    async function loadProfile() {
      try {
        const res = await fetch('/profile');
        const user = await res.json();
    
        document.getElementById('profile-username').textContent = user.username || '';
        document.getElementById('profile-fullname').textContent = user.full_name || '';
        document.getElementById('profile-email').textContent = user.email || '';
        document.getElementById('profile-role').textContent = user.role || '';
    
        document.getElementById('edit-fullname').value = user.full_name || '';
        document.getElementById('edit-username').value = user.username || '';
        document.getElementById('edit-gender').value = user.gender || '';
        document.getElementById('edit-country').value = user.country || '';
        document.getElementById('edit-language').value = user.language || 'English';
        document.getElementById('edit-email').value = user.email || '';
      } catch (err) {
        console.error("Failed to load profile:", err);
      }
    }
    async function eraseAccount() {
      if (confirm("Are you sure you want to erase your account? This cannot be undone.")) {
        try {
          const res = await fetch('/profile/delete', { method: 'POST' });
          if (res.ok) {
            window.location.href = '/';
          } else {
            alert("Error deleting account.");
          }
        } catch (err) {
          console.error(err);
          alert("Error deleting account.");
        }
      }
    }
    
    function logout() {
      window.location.href = '/logout';
    }
    

  </script>
</body>
</html>
