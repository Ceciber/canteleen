<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Interface - Canteleen</title>
  <link rel="stylesheet" href="/css/managerstyle.css">
</head>
<body>
  <div class="cashier-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-top">
        <button onclick="showSection('menu')"><img src="/images/menuicon.png" alt="Menu" class="sidebar-icon"></button>
        <button onclick="showSection('orders')"><img src="/images/ordersicon.png" alt="Orders" class="sidebar-icon"></button>
      </div>
      <div class="sidebar-bottom">
        <hr>
        <button onclick="showSection('profile')"><img src="/images/profileicon.png" alt="Profile" class="sidebar-icon"></button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="cashier-main">
      <!-- Menu Section -->
      <section id="menu" class="active-section">
        <!-- Search Bar and Add Dish Button -->
        <div class="menu-top">
          <input type="text" placeholder="Search dishes..." class="menu-search-input">
          <button class="menu-add-btn" onclick="window.location.href='/adddish'">Add Dish</button>
        </div>
        
        <!-- Tabs for Filtering -->
        <div class="menu-tabs">
          <button class="menu-tab" onclick="filterMeals('All')">All</button>
          <button class="menu-tab" onclick="filterMeals('Menu')">Menu</button>
          <button class="menu-tab" onclick="filterMeals('Meat')">Meat</button>
          <button class="menu-tab" onclick="filterMeals('Vegetarian')">Vegetarian</button>
          <button class="menu-tab" onclick="filterMeals('Fish')">Fish</button>
          <button class="menu-tab" onclick="filterMeals('Dessert')">Dessert</button>
        </div>
        
        <!-- Grid of Meal Tiles -->
        <div class="menu-grid">
          <!-- Tiles will be loaded dynamically -->
        </div>
      </section>

      <script>
        async function loadMeals() {
          try {
            const response = await fetch('/meals');
            const meals = await response.json();
            const grid = document.querySelector('.menu-grid');
            grid.innerHTML = ''; // Clear current tiles
            meals.forEach(meal => {
              const tile = document.createElement('div');
              tile.className = 'meal-tile';
              tile.setAttribute('data-meal-type', meal.meal_type);
              tile.setAttribute('data-inmenu', meal.inMenu);

              // Meal name
              const nameDiv = document.createElement('div');
              nameDiv.className = 'meal-name';
              nameDiv.textContent = meal.meal_name;
              tile.appendChild(nameDiv);

              // Meal image
              const image = document.createElement('img');
              image.className = 'meal-image';
              switch (meal.meal_type.toLowerCase()) {
                case 'vegetarian':
                  image.src = '/images/vegetarianicon.png';
                  break;
                case 'meat':
                  image.src = '/images/meaticon.png';
                  break;
                case 'fish':
                  image.src = '/images/fishicon.png';
                  break;
                case 'dessert':
                  image.src = '/images/desserticon.png';
                  break;
                default:
                  image.src = '/images/defaultmeal.png';
              }
              tile.appendChild(image);

              // Price
              const priceDiv = document.createElement('div');
              priceDiv.className = 'meal-price';
              priceDiv.textContent = `â‚¬${meal.meal_price.toFixed(2)}`;
              tile.appendChild(priceDiv);

              // Action buttons
              const actionsDiv = document.createElement('div');
              actionsDiv.className = 'meal-actions';

              const copyBtn = document.createElement('button');
              copyBtn.textContent = 'Copy';
              copyBtn.onclick = async () => {
                const res = await fetch(`/meals/${meal.id}/copy`, { method: 'POST' });
                if (res.ok) loadMeals();
                else alert("Error copying meal");
              };

              const modifyBtn = document.createElement('button');
              modifyBtn.textContent = 'Modify';
              modifyBtn.onclick = () => {
                window.location.href = `/modifydish?id=${meal.id}`;
              };

              const deleteBtn = document.createElement('button');
              deleteBtn.textContent = 'X';
              deleteBtn.className = 'delete-btn';
              deleteBtn.onclick = async () => {
                const res = await fetch(`/meals/${meal.id}`, { method: 'DELETE' });
                if (res.ok) loadMeals();
                else alert("Error deleting meal");
              };

              actionsDiv.append(copyBtn, modifyBtn, deleteBtn);
              tile.appendChild(actionsDiv);

              grid.appendChild(tile);
            });
          } catch (error) {
            console.error(error);
          }
        }
        
        

        function filterMeals(category) {
          const tiles = document.querySelectorAll('.meal-tile');
          tiles.forEach(tile => {
            const inMenu = tile.getAttribute('data-inmenu');  // Fetch the inMenu value
            const type = tile.getAttribute('data-meal-type');
            
            if (category === 'Menu') {
              tile.style.display = inMenu === "true" ? 'block' : 'none';  // Only show if inMenu=true
            } else if (category === 'All') {
              tile.style.display = 'block';
            } else {
              tile.style.display = type === category ? 'block' : 'none';
            }
          });
        }
        
        
        
        
        

        function setupSearchBar() {
          const searchInput = document.querySelector('.menu-search-input');
          searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            document.querySelectorAll('.meal-tile').forEach(tile => {
              const name = tile.querySelector('.meal-name').textContent.toLowerCase();
              tile.style.display = name.includes(query) ? 'block' : 'none';
            });
          });
        }
        

        document.addEventListener("DOMContentLoaded", () => {
          loadMeals();
          setupSearchBar(); // ðŸ‘ˆ Add this line
        });
        
      </script>


      <!-- Orders Section -->
      <!-- Orders Section -->
    <section id="orders" class="hidden-section">
      <!-- Top Summary Row -->
      <div class="orders-summary">
        <div class="summary-item">
          <label>Total Income</label>
          <div id="total-income">â‚¬0.00</div>
        </div>
        <div class="summary-item">
          <label>Total Orders</label>
          <div id="total-orders">0</div>
        </div>
        <div class="summary-item">
          <label>Amount of Meat meals ordered</label>
          <div id="meat-count">0</div>
        </div>
        <div class="summary-item">
          <label>Amount of Fish meals ordered</label>
          <div id="fish-count">0</div>
        </div>
        <div class="summary-item">
          <label>Amount of Vegetarian meals ordered</label>
          <div id="vegetarian-count">0</div>
        </div>
        <div class="summary-item">
          <label>Amount of Desserts ordered</label>
          <div id="dessert-count">0</div>
        </div>
      </div>

      <!-- Lower Orders Area -->
      <div class="orders-lower">
        <!-- Sidebar B: Order Details -->
        <aside class="order-details-sidebar" id="order-details-sidebar">
          <h3>Order Details</h3>
          <p>Selected Order ID: <span id="selected-order-id">None</span></p>
          <!-- (Optional: Additional order details can be rendered here) -->
        </aside>

        <!-- Space A: Orders List -->
        <div class="orders-list-container">
          <div class="orders-list-header">
            <div class="orders-col order-id-col">Order_ID</div>
            <div class="orders-col items-col">Items</div>
            <div class="orders-col amount-col">Amount</div>
            <div class="orders-col card-col">Card_ID</div>
            <div class="orders-col date-col">Date</div>
          </div>
          <div id="orders-list" class="orders-list">
            <!-- Order rows will be injected here dynamically -->
          </div>
          <div class="orders-instructions">
            <p>Select an order to see relevant details</p>
          </div>
        </div>
      </div>
    </section>

  </section> <!-- end of orders section -->

  <script>
    async function loadOrders() {
      try {
        const response = await fetch('/orders');
        const orders = await response.json();
        const ordersList = document.getElementById('orders-list');
        ordersList.innerHTML = '';
  
        // Variables for aggregated data
        let totalIncome = 0;
        let totalOrders = orders.length;
        let meatCount = 0, fishCount = 0, vegetarianCount = 0, dessertCount = 0;
  
        orders.forEach(order => {
          const items = JSON.parse(order.items);
          let orderTotal = 0, orderItemCount = 0;
  
          items.forEach(item => {
            const qty = item.quantity || 1;
            const price = item.meal_price;
            orderTotal += qty * price;
            orderItemCount += qty;
  
            switch ((item.meal_type || '').toLowerCase()) {
              case 'meat': meatCount += qty; break;
              case 'fish': fishCount += qty; break;
              case 'vegetarian': vegetarianCount += qty; break;
              case 'dessert': dessertCount += qty; break;
            }
          });
  
          totalIncome += orderTotal;
  
          const row = document.createElement('div');
          row.className = 'order-row';
          row.onclick = () => {
            document.getElementById('selected-order-id').textContent = order.order_id;
          };
  
          const colOrderId = document.createElement('div');
          colOrderId.textContent = order.order_id;
  
          const colItems = document.createElement('div');
          colItems.textContent = orderItemCount;
  
          const colAmount = document.createElement('div');
          colAmount.textContent = `â‚¬${orderTotal.toFixed(2)}`;
  
          const colCard = document.createElement('div');
          colCard.textContent = order.card_id;
  
          const colDate = document.createElement('div');
          colDate.textContent = order.date || 'N/A';
  
          row.append(colOrderId, colItems, colAmount, colCard, colDate);
          ordersList.appendChild(row);
        });
  
        // Update summary fields
        document.getElementById('total-income').textContent = `â‚¬${totalIncome.toFixed(2)}`;
        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('meat-count').textContent = meatCount;
        document.getElementById('fish-count').textContent = fishCount;
        document.getElementById('vegetarian-count').textContent = vegetarianCount;
        document.getElementById('dessert-count').textContent = dessertCount;
      } catch (err) {
        console.error("Failed to load orders:", err);
      }
    }
  
    // Load and show orders when page is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Show the orders section right away
      document.querySelectorAll('section').forEach(section => {
        section.style.display = section.id === 'orders' ? 'block' : 'none';
      });
      loadOrders();
    });
  </script>
  
      

      <!-- Profile Section -->
      <section id="profile" class="hidden-section">
        <!-- Profile header with welcome message -->
        <div class="profile-header">
          <h2>Welcome, <span id="profile-username">manager</span></h2>
        </div>

        <!-- Horizontal container for profile picture, details, and edit button -->
        <div class="profile-info">
          <!-- 1) Profile picture -->
          <div class="profile-picture">
            <img src="/images/profile.png" alt="Profile Picture">
          </div>

          <!-- 2) Profile details -->
          <div class="profile-details">
            <p>Name: <span id="profile-fullname">Jane Smith</span></p>
            <p>Email: <span id="profile-email">jane@example.com</span></p>
            <p>Role: <span id="profile-role">manager</span></p>
          </div>

          <!-- 3) Edit button -->
          <div class="profile-edit-btn">
            <button onclick="toggleProfileEdit()">Edit</button>
          </div>
        </div>

        <!-- Grid for editable fields (3 columns x 2 rows) -->
        <div class="profile-grid">
          <div class="profile-field">
            <label for="edit-fullname">Full Name</label>
            <input type="text" id="edit-fullname" value="Jane Smith" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-username">Username</label>
            <input type="text" id="edit-username" value="manager" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-gender">Gender</label>
            <input type="text" id="edit-gender" value="Female" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-country">Country</label>
            <input type="text" id="edit-country" value="France" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-language">Language</label>
            <input type="text" id="edit-language" value="French" disabled>
          </div>
          <div class="profile-field">
            <label for="edit-email">Email</label>
            <input type="text" id="edit-email" value="jane@example.com" disabled>
          </div>
        </div>

        <!-- Erase Account and Log out Section -->
        <div class="account-actions">
          <p class="action-link" onclick="eraseAccount()">Erase account</p>
          <p class="action-link" onclick="logout()">Log out</p>
        </div>
        

        
      </section>

    </main>
  </div>

  <script>
    // Show the selected section and hide others
    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.style.display = section.id === sectionId ? 'block' : 'none';
      });
    
      if (sectionId === 'profile') {
        loadProfile(); // ðŸ‘ˆ Load from DB when switching to profile
      }
    }
    

    // Ensure the manager starts in the menu view
    document.addEventListener("DOMContentLoaded", () => {
      showSection('menu');
    });

    // Toggle between edit and save mode for profile editing
    async function toggleProfileEdit() {
      const inputs = document.querySelectorAll('.profile-field input');
      const editBtn = document.querySelector('.profile-edit-btn button');
    
      if (editBtn.textContent === "Edit") {
        inputs.forEach(input => input.disabled = false);
        editBtn.textContent = "Save";
      } else {
        // Collect updated profile info
        const updatedProfile = {
          full_name: document.getElementById('edit-fullname').value,
          gender: document.getElementById('edit-gender').value,
          country: document.getElementById('edit-country').value,
          language: document.getElementById('edit-language').value,
          email: document.getElementById('edit-email').value
        };
    
        try {
          const res = await fetch('/profile/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedProfile)
          });
          if (res.ok) {
            document.getElementById('profile-fullname').textContent = updatedProfile.full_name;
            document.getElementById('profile-email').textContent = updatedProfile.email;
            editBtn.textContent = "Edit";
            inputs.forEach(input => input.disabled = true);
          } else {
            alert("Error updating profile");
          }
        } catch (err) {
          console.error("Update failed:", err);
        }
      }
    }

    async function loadProfile() {
      try {
        const res = await fetch('/profile');
        const user = await res.json();
    
        document.getElementById('profile-username').textContent = user.username || '';
        document.getElementById('profile-fullname').textContent = user.full_name || '';
        document.getElementById('profile-email').textContent = user.email || '';
        document.getElementById('profile-role').textContent = user.role || '';
    
        document.getElementById('edit-fullname').value = user.full_name || '';
        document.getElementById('edit-username').value = user.username || '';
        document.getElementById('edit-gender').value = user.gender || '';
        document.getElementById('edit-country').value = user.country || '';
        document.getElementById('edit-language').value = user.language || 'English';
        document.getElementById('edit-email').value = user.email || '';
      } catch (err) {
        console.error("Failed to load profile:", err);
      }
    }
    async function eraseAccount() {
      if (confirm("Are you sure you want to erase your account? This cannot be undone.")) {
        try {
          const res = await fetch('/profile/delete', { method: 'POST' });
          if (res.ok) {
            window.location.href = '/';
          } else {
            alert("Error deleting account.");
          }
        } catch (err) {
          console.error(err);
          alert("Error deleting account.");
        }
      }
    }
    
    function logout() {
      window.location.href = '/logout';
    }
    
      async function fetchOrders() {
        try {
          const res = await fetch('/orders');
          const data = await res.json();
          console.log("Orders from database:", data);
        } catch (err) {
          console.error("Error fetching orders:", err);
        }
      }
    
  </script>
</body>
</html>
